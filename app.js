let companies = {"Stiklestad Kulturhus": ["Premiere pÃ¥ ny musical blir utsolgt â†’ kurs opp 40%", "Olav den hellige spÃ¸ker i gangene â†’ kurs ned 25%", "OrdfÃ¸reren roser kulturhuset i tale â†’ kurs opp 15%", "Skuespiller glemmer replikk pÃ¥ scenen â†’ kurs ned 10%", "VR-visning av HÃ¥vamÃ¥l lanseres â†’ kurs opp 30%", "Stiklestadspillet fÃ¥r dÃ¥rlig anmeldelse i Adresseavisen â†’ kurs ned 20%", "Gratis kaffe til alle besÃ¸kende â†’ kurs opp 15%", "Teknisk feil under Ã¥pningsshow â†’ kurs ned 20%", "Kulturhuset selger ut juleshowet pÃ¥ 5 minutter â†’ kurs opp 25%", "Scenen leies ut til rockekonsert med En Dans PÃ¥ Nevroser â†’ kurs opp 35%", "Skuespiller sovner under prÃ¸ve â†’ kurs ned 15%", "Festival trekker dobbelt sÃ¥ mange som i fjor â†’ kurs opp 40%", "Skandale pÃ¥ premierefesten â†’ kurs ned 20%", "Barneteateret imponerer â†’ kurs opp 10%", "Lokal maleriutstilling blir kritikerrost â†’ kurs opp 20%", "StrÃ¸mmen gÃ¥r midt i forestilling â†’ kurs ned 15%", "Ny scene bygges pÃ¥ dugnad â†’ kurs opp 25%", "Improvisert VÃ¸mmÃ¸l-show skaper kaos â†’ kurs opp 15%", "Turistbusser fra Sverige strÃ¸mmer til â†’ kurs opp 30%", "Ingen publikummere mÃ¸ter opp til mandagsforestilling â†’ kurs ned 25%"], "Aker Verdal": ["Ã˜ystein Helden finner opp en genial patent â†’ kurs opp 15%", "Martine RÃ¸nsÃ¥sbjÃ¸rg vinner quiz pÃ¥ julebordet â†’ kurs opp 20%", "Lars Ole Olsen synger Sputnik i hallen â†’ kurs opp 25%", "Gigantkontrakt signert i Brasil â†’ kurs opp 60%", "Streik pÃ¥ verftet â†’ kurs ned 40%", "Kranen setter ny lÃ¸fterekord â†’ kurs opp 30%", "Offshore-krisen rammer hardt â†’ kurs ned 35%", "Innovasjonspris til Aker Verdal â†’ kurs opp 25%", "SnÃ¸storm stopper produksjonen â†’ kurs ned 15%", "Fagforeningen gÃ¥r til streik â†’ kurs ned 20%", "Ny havvind-satsing lanseres â†’ kurs opp 35%", "Ã˜ystein Helden triller pÃ¸lseboden inn i hallen â†’ kurs opp 15%", "Produksjonsrekord pÃ¥ 48 timer â†’ kurs opp 30%", "Martine RÃ¸nsÃ¥sbjÃ¸rg glemmer nÃ¸kler til hallen â†’ kurs ned 10%", "Offisiell Ã¥pning av ny kai â†’ kurs opp 20%", "Feilberegning forsinker leveransen â†’ kurs ned 25%", "Lars Ole Olsen deler ut signerte gitarplektre â†’ kurs opp 10%", "Kaffeautomaten ute av drift â†’ kurs ned 5%", "Statsministeren besÃ¸ker verftet â†’ kurs opp 40%", "Byggestans pÃ¥ grunn av kulde â†’ kurs ned 15%"], "ElvegÃ¥rden Barnehage": ["Barna lager utstilling med lego â†’ kurs opp 15%", "Vannlekkasje i kjelleren â†’ kurs ned 20%", "ForeldreundersÃ¸kelse gir toppscore â†’ kurs opp 25%", "Tre barn lÃ¦rer Ã¥ sykle pÃ¥ samme dag â†’ kurs opp 15%", "Barnehagen fÃ¥r stÃ¸tte til bussturer â†’ kurs opp 20%", "KjÃ¸kkenet gÃ¥r tomt for saft â†’ kurs ned 10%", "Ny lekeapparat pÃ¥ plass â†’ kurs opp 30%", "Stengt pga. omgangssyke â†’ kurs ned 25%", "Prosjekt vant miljÃ¸pris â†’ kurs opp 20%", "Personalet kler seg ut som superhelter â†’ kurs opp 15%", "BrannÃ¸velse gÃ¥r galt â†’ kurs ned 15%", "Barna arrangerer kunstutstilling â†’ kurs opp 20%", "Kaniner pÃ¥ besÃ¸k i barnehagen â†’ kurs opp 15%", "Tidlivakta brenner grÃ¸ten â†’ kurs ned 10%", "Sommeravslutning trekker rekordpublikum â†’ kurs opp 25%", "Juletrefest avlyst â†’ kurs ned 20%", "ForeldremÃ¸te gÃ¥r viralt pÃ¥ TikTok â†’ kurs opp 10%", "Barnehagen fÃ¥r ny minibuss â†’ kurs opp 15%", "Storm Ã¸delegger lekeapparater â†’ kurs ned 20%", "Barn lager VÃ¸mmÃ¸l-sanger â†’ kurs opp 15%"], "Bruktbo Mule": ["Tanja Helden omorganiserer hele butikken pÃ¥ en dag â†’ kurs opp 30%", "Gudrun Ramfjord setter fyr pÃ¥ stol â†’ kurs ned 35%", "Kunde finner hellig relikvium â†’ kurs opp 15%", "NRK lager reportasje om rotete lager â†’ kurs opp 25%", "Tomt for kaffe i kantina â†’ kurs ned 20%", "RekordbesÃ¸k pÃ¥ loppemarked â†’ kurs opp 30%", "Varebil punkterer pÃ¥ E6 â†’ kurs ned 15%", "Sofa fra 70-tallet gÃ¥r viralt pÃ¥ TikTok â†’ kurs opp 40%", "Bruktbo Mule kÃ¥res til GrÃ¸nn bedrift â†’ kurs opp 25%", "Kundeklage pÃ¥ Ã¸delagt TV â†’ kurs ned 10%", "StjÃ¥let sykkel solgt tilbake til eier â†’ kurs opp 15%", "PrisÃ¸kning pÃ¥ retro-mÃ¸bler â†’ kurs opp 30%", "Brukthandlerkonferanse i Verdal â†’ kurs opp 20%", "Boligmarkedet svikter â†’ kurs ned 20%", "Gratisdag gÃ¥r over budsjett â†’ kurs ned 25%", "Gudrun Ramfjord glemmer Ã¥ prise varene â†’ kurs ned 10%", "Tanja Helden arrangerer motevisning i bruktklÃ¦r â†’ kurs opp 20%", "RegnvÃ¦r Ã¸delegger marked â†’ kurs ned 15%", "TikTok-influencer besÃ¸ker Bruktbo â†’ kurs opp 35%", "Bruktbo starter egen podcast â†’ kurs opp 15%"], "Wow Medialab": ["Lina Solstad leverer VR-presentasjon uten strÃ¸m â†’ kurs ned 30%", "TorbjÃ¸rn Solstad lanserer VÃ¸mmÃ¸l-filter i AR â†’ kurs opp 40%", "Wow lager reklamefilm for Prix Ã˜rmelen â†’ kurs opp 20%", "KundemÃ¸te holdes i Minecraft â†’ kurs opp 15%", "Prosjektor eksploderer under demo â†’ kurs ned 25%", "Ny logo kritiseres pÃ¥ Facebook â†’ kurs ned 15%", "Samarbeid med Aker om VR-trening â†’ kurs opp 35%", "Kaffe sÃ¸lt over server â†’ kurs ned 20%", "Lanserer AI som skriver VÃ¸mmÃ¸l-tekster â†’ kurs opp 25%", "Feilskrevet pressemelding gÃ¥r viralt â†’ kurs opp 15%", "Lina Solstad kÃ¥res til Ã¥rets grÃ¼nder â†’ kurs opp 30%", "TorbjÃ¸rn Solstad mister USB-stick med prosjekt â†’ kurs ned 15%", "Wow lager VÃ¸mmÃ¸l-spill i VR â†’ kurs opp 40%", "PC krasjer midt i presentasjon â†’ kurs ned 20%", "Nytt medielab-prosjekt vinner pris â†’ kurs opp 25%", "Hackere legger inn russe-sanger pÃ¥ nettsiden â†’ kurs ned 10%", "Wow Medialab kÃ¥res til beste arbeidsplass â†’ kurs opp 20%", "Lokalavis anklager dem for fake news â†’ kurs ned 15%", "Ny dronefilming av Ã˜rin skaper engasjement â†’ kurs opp 20%", "Investor trekker seg â†’ kurs ned 25%"], "Lag": ["Ole Morten Helden tegner skeiv grunnmur â†’ kurs ned 30%", "Tor Ã…ge Helden mÃ¸ter pÃ¥ byggeplass i bunad â†’ kurs opp 25%", "Byggelaget glemmer spiker â†’ kurs ned 20%", "Vinner anbud pÃ¥ rÃ¥dhus â†’ kurs opp 40%", "Materialprisene skyter i vÃ¦ret â†’ kurs ned 25%", "Hele staben drar pÃ¥ VÃ¸mmÃ¸lfestival â†’ kurs opp 15%", "Ole Morten Helden glemmer tegninger hjemme â†’ kurs ned 10%", "Tor Ã…ge Helden leder rekordrask bygging â†’ kurs opp 35%", "RegnvÃ¦r forsinker prosjekt â†’ kurs ned 20%", "TV2 lager dokumentar om byggeprosjektet â†’ kurs opp 25%", "Arbeidsulykke setter prosjekt pÃ¥ vent â†’ kurs ned 30%", "Kaffeautomaten virker igjen â†’ kurs opp 10%", "Lag fÃ¥r oppdrag i Sverige â†’ kurs opp 30%", "Kommunen avlyser byggeprosjekt â†’ kurs ned 25%", "Ole Morten Helden synger pÃ¥ taket â†’ kurs opp 15%", "Feil mÃ¥l pÃ¥ blÃ¥kopi â†’ kurs ned 20%", "Tor Ã…ge Helden vant byggmester-pris â†’ kurs opp 35%", "Arbeidere streiker â†’ kurs ned 30%", "Kundene jubler over nytt nÃ¦ringsbygg â†’ kurs opp 20%", "Buldoser kjÃ¸rer seg fast â†’ kurs ned 15%"], "NAV Verdal": ["Lars Ã˜yvinn Helden mÃ¸ter til avtalt tid â†’ kurs opp 20%", "System krasjer under meldekort â†’ kurs ned 30%", "NAV-ansatte arrangerer karaoke â†’ kurs opp 15%", "Tiltak for En Dans PÃ¥ Nevroser â†’ kurs opp 40%", "Alle fÃ¥r dobbelt utbetalt ved feil â†’ kurs ned 25%", "Kaffemaskin i resepsjonen gratis â†’ kurs opp 10%", "MÃ¸te med 200 personer pÃ¥ en dag â†’ kurs opp 30%", "Datasystem ute i 3 dager â†’ kurs ned 35%", "Ny NAV-app lanseres â†’ kurs opp 25%", "Bygget mÃ¥ stenge pga. strÃ¸mbrudd â†’ kurs ned 20%", "OrdfÃ¸rer skryter av NAV Verdal â†’ kurs opp 15%", "Lang kÃ¸ utenfor kontoret â†’ kurs ned 10%", "NAV Verdal kÃ¥res til mest effektive i fylket â†’ kurs opp 25%", "Feilutbetaling til 1000 personer â†’ kurs ned 30%", "Gratis vaffeldag pÃ¥ NAV â†’ kurs opp 20%", "Alle printere slutter Ã¥ virke â†’ kurs ned 10%", "NAV Verdal fÃ¥r ny leder â†’ kurs opp 15%", "Systemet blir hacket â†’ kurs ned 40%", "Lars Ã˜yvinn Helden fÃ¥r jobbtilbud â†’ kurs opp 20%", "Arbeidsmarkedstiltak utvides â†’ kurs opp 25%"], "Veksttorget": ["Veronica Helden holder kurs i bÃ¸rs-triks â†’ kurs opp 20%", "CV-mal pÃ¥ nettsiden har skrivefeil â†’ kurs ned 15%", "Veksttorget arrangerer speed-dating for jobbsÃ¸kere â†’ kurs opp 25%", "EU-midler brukt pÃ¥ pizza og brus â†’ kurs ned 20%", "Praktikant oppfinner ny stÃ¸vsuger â†’ kurs opp 30%", "Veronica Helden kÃ¥res til mÃ¥nedens ansatt â†’ kurs opp 15%", "Ny avtale med NAV â†’ kurs opp 20%", "Prosjekt fÃ¥r stÃ¸tte fra Innovasjon Norge â†’ kurs opp 25%", "Datasystem krasjer â†’ kurs ned 20%", "Jobbmesse fÃ¥r rekordoppmÃ¸te â†’ kurs opp 30%", "Veronica Helden glemmer Ã¥ sende ut invitasjoner â†’ kurs ned 15%", "Ny kursserie i intervju-teknikk â†’ kurs opp 20%", "DÃ¥rlig medieomtale i Innherred â†’ kurs ned 25%", "Digital plattform lanseres â†’ kurs opp 20%", "Veksttorget fÃ¥r kritikk for dÃ¥rlig kaffe â†’ kurs ned 10%", "Samarbeid med Wow Medialab â†’ kurs opp 25%", "Ung grÃ¼nder fÃ¥r startpakke â†’ kurs opp 30%", "Veronica Helden synger pÃ¥ personalfesten â†’ kurs opp 10%", "Veksttorget vinner nasjonal pris â†’ kurs opp 40%", "Alle printere stopper samtidig â†’ kurs ned 15%"], "Prix Ã˜rmelen": ["FredagskÃ¸ gir rekordsalg â†’ kurs opp 30%", "Tomt for smÃ¥godt fÃ¸r pÃ¥ske â†’ kurs ned 20%", "Gratis kaffe-kampanje â†’ kurs opp 25%", "Butikksjef glemmer Ã¥ bestille Pepsi Max â†’ kurs ned 30%", "Ny selvbetjent kasse â†’ kurs opp 15%", "Brannalarm gÃ¥r under handletur â†’ kurs ned 25%", "Kundetilfredshet pÃ¥ topp â†’ kurs opp 20%", "Tyveri av smÃ¥godt â†’ kurs ned 10%", "Butikken fÃ¥r pris for billigste melk â†’ kurs opp 15%", "KÃ¸ til langt ut i gata â†’ kurs opp 20%", "Frysedisk gÃ¥r i stykker â†’ kurs ned 20%", "Barn selger lodd utenfor Prix â†’ kurs opp 10%", "Verdal IL handler inn alt til cup â†’ kurs opp 30%", "RegnvÃ¦r Ã¸ker salg av paraplyer â†’ kurs opp 15%", "Kritikk for lange kÃ¸er â†’ kurs ned 15%", "Kundekortkampanje â†’ kurs opp 20%", "Gratis kake ved jubileum â†’ kurs opp 25%", "Energidrikk gÃ¥r viralt â†’ kurs opp 30%", "PrisÃ¸kning pÃ¥ smÃ¸r â†’ kurs ned 15%", "Kaffeavtalen blir revet bort â†’ kurs opp 20%"], "Verdal Hotell": ["Fullbooket under VÃ¸mmÃ¸lfestival â†’ kurs opp 40%", "DÃ¥rlig TripAdvisor-anmeldelse â†’ kurs ned 25%", "Ny konferansesal Ã¥pner â†’ kurs opp 20%", "Kokk mister kontroll pÃ¥ buffeten â†’ kurs ned 15%", "Bryllupsfest varer i tre dager â†’ kurs opp 30%", "Heisen stopper midt i natta â†’ kurs ned 20%", "Hotell fÃ¥r pris for beste frokost â†’ kurs opp 25%", "Gjester klager pÃ¥ stÃ¸y â†’ kurs ned 10%", "Rockeband Ã¸delegger rom â†’ kurs ned 30%", "Kjendis bor pÃ¥ hotellet â†’ kurs opp 20%", "StrÃ¸mbrudd midt under middag â†’ kurs ned 15%", "Gratis spa-weekend utloddes â†’ kurs opp 25%", "Utenbys konferanse flyttes til Verdal â†’ kurs opp 30%", "Kaker forsvinner fra frokostbuffet â†’ kurs ned 10%", "Hotell utvider med ny flÃ¸y â†’ kurs opp 35%", "Brannalarm gÃ¥r under middag â†’ kurs ned 20%", "Gjester deler bilder av utsikten â†’ kurs opp 15%", "Kritikk for dyre rompriser â†’ kurs ned 20%", "Ny sjef ansatt â†’ kurs opp 15%", "Rom selges ut pÃ¥ rekordtid â†’ kurs opp 30%"], "Verdal IL": ["Opprykk til OBOS-ligaen â†’ kurs opp 50%", "Nedrykkstrussel â†’ kurs ned 30%", "Seier mot Levanger FK â†’ kurs opp 25%", "Tap mot Nardo â†’ kurs ned 20%", "Sponsoravtale med Prix Ã˜rmelen â†’ kurs opp 15%", "Ny trener ansatt â†’ kurs opp 20%", "Spiller skÃ¥rer hat-trick â†’ kurs opp 30%", "Keeper glemmer hanskene â†’ kurs ned 15%", "Dugnadsfest gir millionoverskudd â†’ kurs opp 40%", "Spillerekkord i kiosken â†’ kurs opp 10%", "RegnvÃ¦r avlyser kamp â†’ kurs ned 20%", "VÃ¸mmÃ¸lgutta spiller pÃ¥ stadion â†’ kurs opp 35%", "Dommerfeil koster seieren â†’ kurs ned 25%", "Ny tribune Ã¥pner â†’ kurs opp 20%", "Spiller skader seg pÃ¥ trening â†’ kurs ned 15%", "Cupseier feires i tre dager â†’ kurs opp 30%", "Kritikk for dÃ¥rlig gress â†’ kurs ned 10%", "Sponsor trekker seg â†’ kurs ned 25%", "Ung spiller selges til RBK â†’ kurs opp 40%", "Fans arrangerer pyroshow â†’ kurs opp 15%"], "Coop Extra Verdal": ["Rekordomsetning i jula â†’ kurs opp 20%", "Kassedata svikter â†’ kurs ned 15%", "Gratis kaffe til alle â†’ kurs opp 15%", "Lang kÃ¸ til kassa â†’ kurs ned 10%", "Butikken pusser opp â†’ kurs opp 25%", "Brannalarm gÃ¥r midt i handletid â†’ kurs ned 20%", "Kundeklubb gir rekordpÃ¥melding â†’ kurs opp 20%", "Tomt for smÃ¥godt â†’ kurs ned 15%", "Gratis smaksprÃ¸ver trekker kÃ¸ â†’ kurs opp 15%", "Ny fruktavdeling Ã¥pner â†’ kurs opp 20%", "Kritikk for tomme hyller â†’ kurs ned 10%", "Black Friday gir kaos â†’ kurs opp 30%", "Kundekortkampanje â†’ kurs opp 20%", "StrÃ¸mbrudd stopper kassa â†’ kurs ned 25%", "Butikksjef kÃ¥res til Ã¥rets leder â†’ kurs opp 20%", "Gratis handleposer â†’ kurs opp 10%", "Prispress fra konkurrent â†’ kurs ned 15%", "Lokal avis roser ferskvaredisken â†’ kurs opp 15%", "Leveransefeil gir tomme hyller â†’ kurs ned 20%", "Solkampanje pÃ¥ grillmat â†’ kurs opp 15%"], "Farmors Fargerike Verden": ["Eli Anne Helden maler gigantisk veggkunst i sentrum â†’ kurs opp 35%", "Kunstverk velter under Ã¥pning â†’ kurs ned 20%", "Utstilling utsolgt fÃ¸rste dag â†’ kurs opp 40%", "Fargeknapp gÃ¥r viralt pÃ¥ TikTok â†’ kurs opp 25%", "Penselstreik i atelieret â†’ kurs ned 15%", "Barneverksted trekker rekordmange â†’ kurs opp 20%", "Fargemangel hos leverandÃ¸r â†’ kurs ned 10%", "Kritikerroste akvareller â†’ kurs opp 30%", "Regn Ã¸delegger utekunst â†’ kurs ned 15%", "Kunstnerprat pÃ¥ Stiklestad â†’ kurs opp 15%", "Kunstnatt med live-musikk â†’ kurs opp 20%", "Falsk signatur avslÃ¸res â†’ kurs ned 25%", "Samarbeid med Wow Medialab (AR-galleri) â†’ kurs opp 30%", "Feilblandet maling i 50 spann â†’ kurs ned 20%", "Donasjon til barnehager â†’ kurs opp 10%", "Nytt fargekart lanseres â†’ kurs opp 15%", "Gavekortkampanje â†’ kurs opp 20%", "Kunst pÃ¥ togstasjonen skaper debatt â†’ kurs opp 15%", "Levering til Aker Verdal kantine â†’ kurs opp 10%", "Eli Anne Helden vinner lokal kunstpris â†’ kurs opp 35%"]}; // fallback innebygd
let stockPrices = {
  "Aker Verdal": 600,
  "Stiklestad Kulturhus": 300,
  "Coop Extra Verdal": 250,
  "Lag": 230,
  "Verdal Hotell": 200,
  "Verdal IL": 180,
  "Wow Medialab": 150,
  "Veksttorget": 150,
  "NAV Verdal": 140,
  "Bruktbo Mule": 130,
  "ElvegÃ¥rden Barnehage": 110,
  "Prix Ã˜rmelen": 100,
  "Farmors Fargerike Verden": 80
};
let holdings = {}, cash = 1000, day = 1;

let prevPrices = {};            // forrige dags kurs per selskap
let lastChangePct = {};         // siste %-endring per selskap (mot forrige dag)

let totalDays = null; // 10/20/30 eller null
let currentModeKey = null;
let currentDiff = 'easy'; // easy|normal|hard

const NEWS_LIMIT_VISIBLE = 30, NEWS_LIMIT_BUFFER = 200;
let newsBuffer = [];

const DIFFICULTIES = {
  easy:   { startCash:1500, commission:0.005, driftMin:-1.0, driftMax: 1.8, dayBiasRange:0.40 },
  normal: { startCash:1000, commission:0.010, driftMin:-1.5, driftMax: 1.5, dayBiasRange:0.30 },
  hard:   { startCash: 800, commission:0.015, driftMin:-2.0, driftMax: 1.2, dayBiasRange:0.25 }
};

function newsCountToday() { return Math.random() < 0.5 ? 2 : 3; }
function fmt(n) { return `${n.toFixed(0)} kr`; }
function clamp(n) { return Math.max(0, n); }

// --- Bind listeners ASAP (before fetch) ---
document.addEventListener('DOMContentLoaded', () => {
  // buttons
  document.body.addEventListener('click', (e)=>{
    if (e.target.classList.contains('diffBtn')) {
      document.querySelectorAll('.diffBtn').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      currentDiff = e.target.dataset.diff;
      renderHighscores();
    }
    if (e.target.classList.contains('modeBtn')) {
      startGame(e.target.dataset.days);
    }
  });

  document.getElementById('restartBtn').addEventListener('click', () => {
    const key = currentModeKey || '20';
    startGame(key === 'inf' ? 'âˆ' : key);
  });
  document.getElementById('toStartBtn').addEventListener('click', showStart);

  document.getElementById('clearFeedBtn').addEventListener('click', () => { newsBuffer = []; renderFeed(); });
  document.getElementById('compactToggle').addEventListener('change', (e)=>{
    document.getElementById('newsItems').classList.toggle('compact', e.target.checked);
  });

  document.getElementById('nextDayBtn').addEventListener('click', nextDayDebounced);
  document.getElementById('buyBtn').addEventListener('click', buy);
  document.getElementById('sellBtn').addEventListener('click', sell);

  // try fetch external hendelser.json, else keep fallback
  tryLoadExternal().then(() => {
    showStart(); // initialize UI with whichever dataset we have
  });
});

async function tryLoadExternal(){
  try {
    const res = await fetch('hendelser.json', {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    if (json && Object.keys(json).length >= 3) {
      companies = json;
    }
  } catch (err) {
    console.warn('Bruker fallback for hendelser.json:', err.message);
  }
}

function resetState(){
  prevPrices = {};
  lastChangePct = {};
  holdings = {};
  newsBuffer = [];
  day = 1;
  cash = DIFFICULTIES[currentDiff].startCash;
  Object.keys(companies).forEach(n => holdings[n] = 0);
}

function showStart(){
  document.getElementById('startScreen').classList.add('visible');
  document.getElementById('endScreen').classList.remove('visible');
  resetState();
  populateSelect();
  updateUI();
  renderHighscores();
}

function startGame(daysChoice){
  if (daysChoice === 'âˆ') { totalDays = null; currentModeKey = 'inf'; }
  else { totalDays = parseInt(daysChoice,10); currentModeKey = String(totalDays); }
  document.getElementById('startScreen').classList.remove('visible');
  document.getElementById('endScreen').classList.remove('visible');
  resetState();
  updateUI();
}

function renderHighscores(){
  const labels = {'10':'10 dager','20':'20 dager','30':'30 dager','inf':'Uendelig'};
  const hsDiv = document.getElementById('highscores');
  const modes = ['10','20','30','inf'];
  const dLabel = {easy:'Lett', normal:'Normal', hard:'Hard'}[currentDiff];
  const lines = modes.map(m=>{
    const key = `ib_highscore_${m}_${currentDiff}`;
    const val = localStorage.getItem(key);
    return `<div>Highscore ${labels[m]} â€“ ${dLabel}: <strong>${val ? Number(val).toFixed(0)+' kr' : 'â€“'}</strong></div>`;
  });
  hsDiv.innerHTML = lines.join('');
}

function maybeEndGame(){
  if (totalDays && day > totalDays){
    const p = portfolioValue();
    const total = p + cash;
    document.getElementById('sumMode').textContent = (currentModeKey==='inf'?'Uendelig': currentModeKey+' dager');
    document.getElementById('sumDiff').textContent = {easy:'Lett', normal:'Normal', hard:'Hard'}[currentDiff];
    document.getElementById('sumDays').textContent = totalDays;
    document.getElementById('sumCash').textContent = fmt(cash);
    document.getElementById('sumPortfolio').textContent = fmt(p);
    document.getElementById('sumTotal').textContent = fmt(total);
    const key = `ib_highscore_${currentModeKey || '20'}_${currentDiff}`;
    const prev = Number(localStorage.getItem(key) || 0);
    let note = '';
    if (!prev || total > prev){ localStorage.setItem(key, String(total)); note = 'ğŸ‰ Ny highscore!'; }
    else { note = `Beste til nÃ¥: ${prev.toFixed(0)} kr`; }
    document.getElementById('sumHighscore').textContent = note;
    document.getElementById('endScreen').classList.add('visible');
  }
}

function populateSelect() {
  const select = document.getElementById('companySelect');
  select.innerHTML = '';
  Object.keys(companies).forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = `${name} (${fmt(stockPrices[name] ?? 100)})`;
    select.appendChild(option);
  });
}


function updatePricesPanel() {
  const container = document.getElementById('prices');
  container.innerHTML = '';
  Object.entries(stockPrices)
    .sort((a,b)=>a[0].localeCompare(b[0]))
    .forEach(([name,price])=>{
      const prev = prevPrices[name] ?? price;
      const pct = prev ? ((price/prev)-1)*100 : 0;
      lastChangePct[name] = pct;
      let arrow = 'â¸ï¸', deltaClass='flat';
      if (pct > 0.05) { arrow='â–²'; deltaClass='up'; }
      else if (pct < -0.05) { arrow='â–¼'; deltaClass='down'; }
      const row = document.createElement('div');
      row.className = 'price';
      row.innerHTML = `<span class="name"><span class="arrow ${deltaClass}">${arrow}</span>${name}</span>
                       <strong>${fmt(price)}</strong>
                       <span class="delta ${deltaClass}">${pct>=0?'+':''}${pct.toFixed(1)}%</span>`;
      container.appendChild(row);
    });
}

